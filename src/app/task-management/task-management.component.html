<link
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  rel="stylesheet"
/><div class="task-management-container">
  <!-- User List -->
  <div class="user-list" *ngIf="users.length > 0">
    <h2>Manage Users</h2>
    <div class="user-card-container">
      <div
        class="user-card"
        *ngFor="let user of users"
        (click)="fetchTasksForUser(user.uid)"
        [class.selected]="selectedUserId === user.uid"
      >
        <div class="user-card-content">
          <div class="user-avatar" (click)="triggerFileInput($event, fileInput, user)">
            <!-- If a photo URL exists, show the image; otherwise, show a placeholder -->
            <img *ngIf="user.photoURL" [src]="user.photoURL" alt="User Avatar" class="profile-photo" />
            <span *ngIf="!user.photoURL" class="placeholder-icon">ðŸ‘¤</span>
            <!-- Hidden file input -->
            <input type="file" #fileInput accept="image/*" hidden (change)="uploadPicture(user, $event)" />
          </div>
          
          <div class="user-info">
            <p class="user-name">{{ user.email.split('@')[0] | uppercase }}</p>
            <p class="user-budget">{{ user.budget | currency: 'USD' }}</p>
          </div>
          <div class="button-container">
            <button
              class="btn-icon"
              (click)="confirmDeleteUser(user.uid); $event.stopPropagation()"
              title="Delete User"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add User and Create Task Buttons -->
  <div class="action-buttons">
    <button class="btn btn-primary" (click)="openAddUserModal()">+ Add User</button>
    <button class="btn btn-secondary" (click)="openAddTaskModal()">+ Create Task</button>
  </div>

  <!-- Add User Modal -->
  <div class="modal" *ngIf="isAddUserModalVisible">
    <div class="modal-content">
      <span class="close-button" (click)="closeAddUserModal()">&times;</span>
      <h3>Add a New User</h3>
      <form (ngSubmit)="addUser()">
        <div class="form-group">
          <label for="email">User Email</label>
          <input
            id="email"
            type="email"
            [(ngModel)]="newUserEmail"
            name="email"
            class="input-field"
            placeholder="Enter User Email"
            required
          />
        </div>
        <div class="form-group">
          <label for="budget">Budget</label>
          <input
            id="budget"
            type="number"
            [(ngModel)]="newUserBudget"
            name="budget"
            class="input-field"
            placeholder="Enter Initial Budget"
            required
          />
        </div>
        <button type="submit" class="btn btn-success">Add User</button>
      </form>
    </div>
  </div>

  <!-- Confirmation Dialog -->
  <div class="modal" *ngIf="isDeleteDialogVisible">
    <div class="modal-content">
      <!-- Top-right close button -->
      <button class="close-icon" (click)="closeDeleteDialog()">
        &times;
      </button>
  
      <!-- Centered "X" icon -->
      <div class="modal-header">
        <div class="icon-circle">
          <i class="fas fa-times"></i>
        </div>
      </div>
  
      <h3>Are you sure?</h3>
      <p>Do you really want to delete these records? This process cannot be undone.</p>
  
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteDialog()">Cancel</button>
        <button class="btn btn-danger" (click)="deleteUser()">Delete</button>
      </div>
    </div>
  </div>
  


  <!-- Task Edit Modal -->
  <div class="modal" *ngIf="isEditModalOpen">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Task</h2>
        <span class="close-button" (click)="closeEditTaskModal()">&times;</span>
      </div>
      <form (ngSubmit)="updateTask()" class="edit-task-form">
        <div class="form-group">
          <label for="title">Task Title</label>
          <input
            id="title"
            type="text"
            [(ngModel)]="editingTask.title"
            name="title"
            placeholder="Enter task title"
            required
          />
        </div>
        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input
            id="dueDate"
            type="date"
            [(ngModel)]="editingTask.dueDate"
            name="dueDate"
            required
          />
        </div>
        <div class="form-group">
          <label for="urgency">Urgency</label>
          <select id="urgency" [(ngModel)]="editingTask.urgency" name="urgency" required>
            <option value="high">High (Red)</option>
            <option value="medium">Medium (Yellow)</option>
            <option value="low">Low (Green)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="description">Task Description</label>
          <textarea
            id="description"
            [(ngModel)]="editingTask.description"
            name="description"
            placeholder="Enter task description"
            required
          ></textarea>
        </div>
        <button type="submit" class="btn btn-success">Update</button>
      </form>
    </div>
  </div>
  

  <!-- Add Task Modal -->
  <div class="modal" *ngIf="isAddTaskModalVisible">
    <div class="modal-content">
      <span class="close-button" (click)="closeAddTaskModal()">&times;</span>
      <h3>Add a New Task</h3>
      <form (ngSubmit)="addTask()">
        <div class="form-group">
          <label for="taskTitle">Task Title</label>
          <input
            id="taskTitle"
            type="text"
            [(ngModel)]="taskTitle"
            name="taskTitle"
            class="input-field"
            placeholder="Enter Task Title"
            required
          />
        </div>
        <div class="form-group">
          <label for="taskDescription">Task Description</label>
          <textarea
            id="taskDescription"
            [(ngModel)]="taskDescription"
            name="taskDescription"
            class="input-field"
            placeholder="Enter Task Description"
            required
          ></textarea>
        </div>
        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input
            id="dueDate"
            type="date"
            [(ngModel)]="dueDate"
            name="dueDate"
            class="input-field"
            required
          />
        </div>
        <div class="form-group">
          <label for="assignUser">Assign to User</label>
          <input
            id="assignUser"
            type="text"
            [(ngModel)]="assignUserInput"
            (input)="filterUsers()"
            name="assignUser"
            class="input-field"
            placeholder="Enter User Name"
            required
            autocomplete="off"
          />
          <ul *ngIf="filteredUsers.length > 0" class="dropdown">
            <li
              *ngFor="let user of filteredUsers"
              (click)="selectUser(user)"
              class="dropdown-item"
            >
              {{ user.name }}
            </li>
          </ul>
        </div>
        <div>
          <label for="urgency">Urgency</label>
          <select id="urgency" [(ngModel)]="editingTask.urgency" name="urgency" required>
            <option value="high">High (Red)</option>
            <option value="medium">Medium (Yellow)</option>
            <option value="low">Low (Green)</option>
          </select>
        </div>
        <button type="submit" class="btn btn-success">Create Task</button>
      </form>
    </div>
  </div>

  <!-- Task List Section -->
  <div class="task-list" *ngIf="tasks.length > 0">
    <h3>Tasks for User: {{ selectedUserId }}</h3>
    <table class="tasks-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Urgency</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of tasks" [ngClass]="getTaskClass(task.urgency)">
          <td>{{ task.title || 'Untitled' }}</td>
          <td>{{ task.description || 'No description' }}</td>
          <td>{{ task.dueDate || 'No due date' }}</td>
          <td>
            <span class="status-badge">{{ task.status }}</span>
          </td>
          <td>
            <span [class]="'urgency-badge ' + task.urgency">{{ task.urgency }}</span>
          </td>
          <td class="task-actions">
            <button class="btn btn-warning" (click)="openEditTaskModal(task, selectedUserId)">Edit</button>
            <button
              class="btn btn-danger"
              (click)="confirmAndDeleteTask(task.id, selectedUserId)"
            >
              Delete
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No Tasks Message -->
  <p *ngIf="tasks.length === 0 && selectedUserId" class="no-tasks-message">
    No tasks available for this user.
  </p>
</div>
