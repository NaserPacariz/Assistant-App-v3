
<div class="task-management-container">
  <div class="back-arrow-container">
    <button class="back-arrow" (click)="goBack()">&larr;</button>
  </div>
  <h1 class="page-title">Manage user tasks</h1>

<div class="div-add-task">
  <button class="btn btn-secondary" (click)="openAddTaskModal()">+ Create Task</button>
</div>
  
  <!-- Task Items Section -->
  <div class="task-list" *ngIf="tasks.length > 0">
    <div class="table-responsive">
    <table class="tasks-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Stage</th>
          <th>Labels</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of tasks">
          <td>{{ task.title || 'Untitled' }}</td>
          <td>{{ task.startDate || 'No Start Date' }}</td>
          <td>{{ task.endDate || 'No End Date' }}</td>
          <td>
            <span class="stage-badge">{{ task.stage || 'No Stage' }}</span>
          </td>
          <td>
            <div class="labels">
              <span *ngFor="let label of task.labels" class="label-badge">
                {{ label }}
              </span>
            </div>
          </td>
          <td class="task-actions">
            <button class="btn btn-info" (click)="viewDescription(task)">
              View Description
            </button>
            <button class="btn btn-warning" (click)="openEditTaskModal(task)">
              Edit
            </button>
            <button class="btn btn-danger" (click)="confirmAndDeleteTask(task.id)">
              Delete
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    </div>
  </div>

<!-- Delete Confirmation Modal -->
<div class="modal delete-confirmation-modal" *ngIf="showDeleteConfirmation">
  <div class="modal-content">
    <!-- Top-right 'close' X -->
    <button class="close-icon" (click)="cancelDelete()">&times;</button>

    <!-- Large circle with X in the center -->
    <div class="icon-circle">
      <span class="big-x">&times;</span>
    </div>

    <!-- Main heading -->
    <h2 class="modal-title">Are you sure?</h2>
    <!-- Subtext -->
    <p class="modal-subtext">
      Do you really want to delete these records?
      <br />
      This process cannot be undone.
    </p>

    <!-- Footer with two buttons side by side -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
      <button class="btn btn-danger" (click)="deleteTask(selectedTaskId!)">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Success Popup Modal -->
<div class="success-modal" *ngIf="showSuccessPopup">
  <div class="success-modal-content">
    <div class="success-modal-body">
      <h2>Task deleted successfully!</h2>
    </div>
  </div>
</div>


  <div class="modal" *ngIf="isDescriptionModalVisible">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Task Description</h3>
        <span class="close-button" (click)="closeDescriptionModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p>{{ selectedTaskDescription }}</p>
      </div>
    </div>
  </div>

  <div class="budget-management-container">
    <h2>Budget Management</h2>
  
    <!-- Add Budget Form -->
    <form (ngSubmit)="addBudget()" #addBudgetForm="ngForm" class="budget-form">
      <div class="form-group">
        <label for="amount">Budget Amount</label>
        <input
          type="number"
          id="amount"
          [(ngModel)]="amount"
          name="amount"
          placeholder="Enter Budget Amount"
          required
          #amountInput="ngModel"
        />
        <p class="error-message" *ngIf="amountInput.invalid && amountInput.touched">
          Budget amount is required and must be greater than 0.
        </p>
      </div>
      <div class="form-group">
        <label for="month">Select Month</label>
        <input
          type="month"
          id="month"
          [(ngModel)]="month"
          name="month"
          [value]="currentMonth"
          required
        />
      </div>
      <button type="submit" class="btn btn-success" [disabled]="addBudgetForm.invalid || loading">
        Add Budget
      </button>
    </form>
  
    <!-- Deduct Budget Form -->
    <form (ngSubmit)="deductBudget()" #deductBudgetForm="ngForm" class="budget-form">
      <div class="form-group">
        <label for="deduction">Deduction Amount</label>
        <input
          type="number"
          id="deduction"
          [(ngModel)]="deduction"
          name="deduction"
          placeholder="Enter Deduction Amount"
          required
          #deductionInput="ngModel"
        />
        <p class="error-message" *ngIf="deductionInput.invalid && deductionInput.touched">
          Deduction amount is required and must be greater than 0.
        </p>
      </div>
      <div class="form-group">
        <label for="deductMonth">Select Month</label>
        <input
          type="month"
          id="deductMonth"
          [(ngModel)]="deductionMonth"
          name="deductMonth"
          [value]="currentMonth"
          required
        />
      </div>
      <button type="submit" class="btn btn-warning" [disabled]="deductBudgetForm.invalid || loading">
        Deduct Budget
      </button>
    </form>
    
    <div class="budget-history-section">
      <button 
        class="btn btn-primary" 
        [routerLink]="['/budget-history', userId]" 
        *ngIf="userId">
        View Budget History
      </button>
    </div>
    
  
  <!-- No Tasks Message -->
  <p *ngIf="tasks.length === 0" class="no-tasks-message">No tasks available for this user.</p>
  

  <!-- Add Task Modal -->
  <div class="add-task-modal" *ngIf="isAddTaskModalVisible">
    <div class="add-task-modal-content">
      <!-- Close Button -->
      <span
        class="close-button"
        (click)="closeAddTaskModal()"
        *ngIf="!isLoading && !isSuccess"
      >
        &times;
      </span>
  
      <!-- Title -->
      <h3 class="modal-title" *ngIf="!isLoading && !isSuccess">Add Task</h3>
  
      <!-- Spinner -->
      <div class="spinner-container" *ngIf="isLoading">
        <div class="spinner"></div>
      </div>
  
      <!-- Success Message -->
      <div class="success-container" *ngIf="isSuccess">
        <i class="fas fa-check-circle success-icon"></i>
        <p class="after-spinner-text">Task Added Successfully! ✔️</p>
      </div>
  
      <!-- Task Form -->
      <form
        (ngSubmit)="addTask()"
        class="add-task-form"
        *ngIf="!isLoading && !isSuccess"
      >
        <div class="form-group">
          <label for="taskTitle">Task Title</label>
          <input
            id="taskTitle"
            type="text"
            [(ngModel)]="taskTitle"
            name="taskTitle"
            required
            placeholder="Enter title"
          />
        </div>
        <div class="form-group">
          <label for="taskDescription">Task Description</label>
          <textarea
            id="taskDescription"
            [(ngModel)]="taskDescription"
            name="taskDescription"
            required
            placeholder="Enter description"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input
            id="dueDate"
            type="date"
            [(ngModel)]="dueDate"
            name="dueDate"
            required
          />
        </div>
        <div class="form-group">
          <label for="urgency">Urgency</label>
          <select id="urgency" [(ngModel)]="urgency" name="urgency" required>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Add Task</button>
        </div>
      </form>
    </div>
  </div>
  
  
  <div class="modal edit-task-modal" *ngIf="isEditModalOpen">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <input
          type="text"
          [(ngModel)]="editingTask.title"
          class="task-title-input"
          placeholder="Name of task"
        />
        <button class="close-button" (click)="closeEditTaskModal()">
          <i class="fas fa-times">X</i>
        </button>
      </div>
      <form (ngSubmit)="updateTask()" class="edit-task-form">
        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input
            id="dueDate"
            type="date"
            [(ngModel)]="editingTask.dueDate"
            name="dueDate"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="urgency">Urgency</label>
          <select id="urgency" [(ngModel)]="editingTask.urgency" name="urgency" class="form-input" required>
            <option value="high">High (Red)</option>
            <option value="medium">Medium (Yellow)</option>
            <option value="low">Low (Green)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="description">Task Description</label>
          <textarea
            id="description"
            [(ngModel)]="editingTask.description"
            name="description"
            class="form-input description-input"
            placeholder="Enter task description"
            required
          ></textarea>
        </div>
        <button type="submit" class="btn btn-success">Update</button>
      </form>
    </div>
  </div>
  
</div>